<%if !current_user.no_warning && (!current_user.address || !current_user.address.valid_address)%>
<div class="address-warning alert alert-warning mar-t-30 mar-b-0">
  <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <div class="warning-content">
    <h4><i class="fa fa-warning mar-r-10"></i>Warning</h4>
    <p>You did not enter a valid address, and people might not want to carpool with someone who lives 99999 miles away. Here is what you can do:</p>
    <div class="flex-centered mar-t-15">
      <%=link_to 'Edit My Address', account_overview_path(current_user), class:'flex-item-3 label label-success'%>
      <a id="geolocation-button" class="label label-info flex-item-3">Set Address Using My GPS Data</a>
      <a id="close-button" class="label label-danger flex-item-3">I Don't Care, Don't Show Me This Again</a>
    </div>
  </div>
</div>
<input type="hidden" id="latitude" value=""/>
<input type="hidden" id="longitude" value=""/>
<script>
function setAddressWithGeolocation() {
  navigator.geolocation.getCurrentPosition(
    onSuccess,
    onError, {
      enableHighAccuracy: true,
      timeout: 20000,
      maximumAge: 120000
    }
  );
  function onSuccess(position) {
    $.post('/set_address_with_geolocation',position)
  }
  function onError(err) {
    var message;
    switch (err.code) {
      case 0:
      message = 'Unknown error: ' + err.message;
      break;
      case 1:
      message = 'You denied permission to retrieve a position.';
      break;
      case 2:
      message = 'The browser was unable to determine a position: ' + error.message;
      break;
      case 3:
      message = 'The browser timed out before retrieving the position.';
      break;
    }
  }
}

function disableWarning(){
  var userId = "<%=current_user.id%>"
  $.ajax({
    url: "/update_user/" + userId,
    dataType: 'json',
    type: 'PUT',
    data: {'user':{'no_warning':true}},
    error: function(xhr, status, err) {
      console.error( status, err.toString());
    }
  })
}

$('#close-button').click(function(){
  $('.address-warning').hide();
  disableWarning();
})
$('#geolocation-button').click(function(){
  $('.warning-content').html('<h4 class="mar-y-10"><i class="fa fa-globe mar-r-10 pulsate" aria-hidden="true"></i>searching for your address via google maps API...</h4>')
  setAddressWithGeolocation();
})
</script>
<%end%>
