<% publish_to @path do %>
var id = "<%= @conversation.id %>";
var chatbox = $("#chatbox_" + id + " .chatboxcontent");
var sender_id = "<%= @message.user.id %>";
var reciever_id = $('meta[name=user-id]').attr("content");
var conversation_tab = $("#conversation-tab-"+id);

//check if repeated request
var messageId = "<%= @message.id %>";
var lastMessageId = chatbox.data('last_message_id');
var uniqueMessage = messageId !== lastMessageId

if (uniqueMessage) {
  conversation_tab.html("<%= j render( partial: @message ) %>");
  chatbox.append("<%= j render( partial: @message ) %>");
  if (chatbox[0]) {
    chatbox.scrollTop(chatbox[0].scrollHeight);
  }
  if(sender_id != reciever_id){
    chatBox.chatWith(id);
    chatbox.children().last().removeClass("self").addClass("other");
    if (chatbox[0]) {
      chatbox.scrollTop(chatbox[0].scrollHeight);
    }
    console.log(messageId)
    chatBox.notify();
  }
  chatbox.data('last_message_id', messageId)
}

<% end %>
